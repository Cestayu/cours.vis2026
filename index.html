import { useState, useMemo } from 'react';
import { motion } from 'framer-motion';
import { Film } from 'lucide-react';
import { movieData } from '@/data/movieData';
import { StatCard } from '@/components/cinema/StatCard';
import { FilterControls } from '@/components/cinema/FilterControls';
import { TabNavigation, Tab } from '@/components/cinema/TabNavigation';
import { OverviewChart } from '@/components/cinema/OverviewChart';
import { GenreChart } from '@/components/cinema/GenreChart';
import { DirectorChart } from '@/components/cinema/DirectorChart';
import { TimelineChart } from '@/components/cinema/TimelineChart';
import { MovieGallery } from '@/components/cinema/MovieGallery';

const Index = () => {
  const [activeTab, setActiveTab] = useState<Tab>('overview');
  const [selectedYear, setSelectedYear] = useState('all');
  const [selectedGenre, setSelectedGenre] = useState('all');
  const [selectedDirector, setSelectedDirector] = useState('all');
  const [selectedActor, setSelectedActor] = useState('all');

  // Extract unique values for filters
  const years = useMemo(() => 
    [...new Set(movieData.map(d => d.year))].sort((a, b) => a - b), 
    []
  );
  
  const genres = useMemo(() => 
    [...new Set(movieData.map(d => d.genre))].sort(), 
    []
  );
  
  const directors = useMemo(() => 
    [...new Set(movieData.map(d => d.director))].sort(), 
    []
  );
  
  const actors = useMemo(() => 
    [...new Set(movieData.map(d => d.actor || 'Unknown'))].filter(a => a !== 'Unknown').sort(), 
    []
  );

  // Filter data
  const filteredData = useMemo(() => {
    return movieData.filter(d => {
      const actorVal = d.actor || 'Unknown';
      return (
        (selectedYear === 'all' || d.year === Number(selectedYear)) &&
        (selectedGenre === 'all' || d.genre === selectedGenre) &&
        (selectedDirector === 'all' || d.director === selectedDirector) &&
        (selectedActor === 'all' || actorVal === selectedActor)
      );
    });
  }, [selectedYear, selectedGenre, selectedDirector, selectedActor]);

  // Calculate stats
  const stats = useMemo(() => {
    const total = filteredData.length;
    const totalRevenue = filteredData.reduce((sum, d) => sum + d.boxOffice, 0);
    const avgRevenue = total > 0 ? totalRevenue / total : 0;

    // Find top genre by count
    const genreCounts = filteredData.reduce((acc, d) => {
      acc[d.genre] = (acc[d.genre] || 0) + 1;
      return acc;
    }, {} as Record<string, number>);

    const topGenre = Object.entries(genreCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';

    return {
      totalMovies: total,
      totalBoxOffice: `$${(totalRevenue / 1000).toFixed(1)}B`,
      avgRevenue: `$${avgRevenue.toFixed(0)}M`,
      topGenre,
    };
  }, [filteredData]);

  const handleReset = () => {
    setSelectedYear('all');
    setSelectedGenre('all');
    setSelectedDirector('all');
    setSelectedActor('all');
  };

  const renderChart = () => {
    switch (activeTab) {
      case 'overview':
        return <OverviewChart data={filteredData} />;
      case 'genre':
        return <GenreChart data={filteredData} />;
      case 'director':
        return <DirectorChart data={filteredData} />;
      case 'timeline':
        return <TimelineChart data={filteredData} />;
      case 'gallery':
        return <MovieGallery data={filteredData} />;
      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <div className="container max-w-7xl mx-auto px-4 py-8">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
          className="text-center mb-8"
        >
          <div className="flex items-center justify-center gap-3 mb-2">
            <Film className="w-10 h-10 text-primary" />
            <h1 className="text-4xl md:text-5xl font-display font-bold text-foreground">
              CINEMA
            </h1>
          </div>
          <p className="text-muted-foreground text-lg">
            Box Office Explorer • 2013–2023
          </p>
        </motion.div>

        {/* Filters */}
        <FilterControls
          years={years}
          genres={genres}
          directors={directors}
          actors={actors}
          selectedYear={selectedYear}
          selectedGenre={selectedGenre}
          selectedDirector={selectedDirector}
          selectedActor={selectedActor}
          onYearChange={setSelectedYear}
          onGenreChange={setSelectedGenre}
          onDirectorChange={setSelectedDirector}
          onActorChange={setSelectedActor}
          onReset={handleReset}
        />

        {/* Stats */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <StatCard label="Total Movies" value={stats.totalMovies} delay={0} />
          <StatCard label="Total Box Office" value={stats.totalBoxOffice} delay={0.1} />
          <StatCard label="Average Revenue" value={stats.avgRevenue} delay={0.2} />
          <StatCard label="Top Genre" value={stats.topGenre} delay={0.3} />
        </div>

        {/* Tab Navigation */}
        <TabNavigation activeTab={activeTab} onTabChange={setActiveTab} />

        {/* Chart/Gallery */}
        {renderChart()}

        {/* Genre Legend */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.5, delay: 0.5 }}
          className="mt-6 glass-card p-4"
        >
          <h3 className="text-xs uppercase tracking-widest text-muted-foreground mb-3 text-center">
            Genre Color Legend
          </h3>
          <div className="flex flex-wrap justify-center gap-3">
            {[
              { name: 'Action', color: 'hsl(0, 85%, 55%)' },
              { name: 'Superhero', color: 'hsl(340, 80%, 55%)' },
              { name: 'Animation', color: 'hsl(160, 70%, 45%)' },
              { name: 'Fantasy', color: 'hsl(280, 65%, 55%)' },
              { name: 'Sci-Fi', color: 'hsl(200, 90%, 50%)' },
              { name: 'Drama', color: 'hsl(30, 60%, 50%)' },
              { name: 'Comedy', color: 'hsl(50, 90%, 55%)' },
              { name: 'Adventure', color: 'hsl(25, 85%, 55%)' },
            ].map((genre) => (
              <div key={genre.name} className="flex items-center gap-2">
                <div
                  className="w-3 h-3 rounded-full"
                  style={{ backgroundColor: genre.color }}
                />
                <span className="text-xs text-muted-foreground">{genre.name}</span>
              </div>
            ))}
          </div>
        </motion.div>
      </div>
    </div>
  );
};

export default Index;
